version: 2.1

setup: true
 
orbs:
  continuation: circleci/continuation@0.1.2
  aws-s3: circleci/aws-s3@3.0.0
  nx: nrwl/nx@1.1.0

parameters:
  affected-app:
    default: "./check-affected"
    type: string

workflows:
  pipeline-proxy:   
    jobs:
      - router: 
          context: heycar
      - install-dependencies:
          context: heycar
      - fetch-locales:
          context: heycar
          requires:
            - install-dependencies
      - run-unit-tests:
          context: heycar
          requires:
            - fetch-locales
      - run-linter:
          context: heycar
          requires:
            - fetch-locales

definitions:
  node_image: &node-image
    docker:
      - image: cimg/node:14.15.5

  node_cypress_image: &node_cypress_image
    docker:
      - image: cypress/base-14-7-0

  cypress-env: &cypress-env
    CYPRESS_CACHE_FOLDER: .cache/Cypress

jobs:
  router:
    executor: continuation/default
    steps:
      - checkout
      - run: echo "Proxy routes to $(basename << pipeline.parameters.affected-app >>) pipeline"
      - continuation/continue:
          configuration_path: ".circleci/<< pipeline.parameters.affected-app >>.yml"
  preprocess: 
    steps: 
      - run: echo "Run Preprocess." 
  install-dependencies:
    <<: *node-image
    description: Install dependencies
    environment:
      <<: *cypress-env
    steps:
      - run: echo "Install Dependencies."
  fetch-locales:
    executor: phrase-2-4-10
    description: Fetch locales from phrase
    steps:
      - run: echo "Fetching Locales"

  run-unit-tests:
    <<: *node-image
    description: Run unit tests
    steps:
      - run: echo "Run Unit tests."

  run-linter:
    <<: *node-image
    description: Run linter
    steps:
      - run: echo "Run Linter."